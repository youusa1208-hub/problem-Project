package dao;

import java.sql.*;
import java.util.*;
import javax.naming.*;
import beans.PokeBean;

public class PokeDao extends Dao {

	public List<PokeBean> select() 
			throws NamingException, SQLException {
		List<PokeBean>list = new ArrayList<>();
		String sql = "SELECT pid,pname,pimg,pk.ptid,"
				+"Ptname,ptimg FROM pokemon pk"
				+"JOIN ptype pt ON pk.ptid=pt.ptid"
				+" ORDER BY pid";
		PreparedStatement stmt = prepareStatement(sql);
		ResultSet rs = stmt.executeQuery();
		while(rs.next()){
			PokeBean pb = new PokeBean<>();
			pb.setPid(rs.getInt("pid"));
			pb.setPname(rs.getString("pname"));
			pb.setPimg(rs.getString("pimg"));
			pb.setPtid(rs.getInt("ptid"));
			pb.setPtname(rs.getString("ptname"));
			pb.setPtimg(rs.getString("ptimg"));
			list.add(pb);
		}
		return list;
	}

	public PokeBean select(int pid) 
			throws NamingException, SQLException {
		PokeBean pb = new PokeBean();
		String sql = "SELECT * FROM pokemon pk"
				+"JOIN ptype pt ON pk.ptid=pt.ptid"
				+"WHERE pid=?";
		PreparedStatement stmt = prepareStatement(sql);
//		バインド
		stmt.setInt(1, pid);
		ResultSet rs = stmt.executeQuery();
		if(rs.next()){
			pb.setPid(rs.getInt("pid"));
			pb.setPname(rs.getString("pname"));
			pb.setPimg(rs.getString("pimg"));
			pb.setPtid(rs.getInt("ptid"));
			pb.setPtname(rs.getString("ptname"));
			pb.setPtimg(rs.getString("ptimg"));
		}
		return pb;
	}

	public void insert(PokeBean pb) 
			throws NamingException, SQLException {
//		副問合せ→()で囲む
		String sql1 = "(SELECT MAX(pid)+1 FROM pokemon)";
		String sql = "INSERT INTO pokemon(pid,pname,pimg,ptid)"
				+"VALUES("+sql1+",?,?,?)";
		PreparedStatement stmt = prepareStatement(sql);
		stmt.setString(1, pb.getPname());
		stmt.setString(2, pb.getPimg());
		stmt.setInt(3, pb.getPid());
		stmt.executeUpdate();
	}

	public void delete(int pid) 
			throws NamingException, SQLException {
		String sql ="DELETE FORM pokemon WHERE pid=?";
		PreparedStatement stmt = prepareStatement(sql);
		stmt.setInt(1, pid);
		stmt.executeUpdate();
	}

	public void update(PokeBean pb) 
			throws NamingException, SQLException {
		String sql ="UPDATE pokemon SET pname=?,pimg=?,"
				+"ptid=? WHERE pid=?";
		PreparedStatement stmt = prepareStatement(sql);
		stmt.setString(1, pb.getPname());
		stmt.setString(2, pb.getPimg());
		stmt.setInt(3, pb.getPtid());
		stmt.setInt(4, pb.getPid());
		stmt.executeUpdate();
	}
}